$(function(){var e={support:{touch:"ontouchend"in document,localStorage:function(){try{return"localStorage"in window&&null!==window.localStorage}catch(e){return!1}}},isString:function(e){return"[object String]"===Object.prototype.toString.call(e)?!0:!1},downloadFile:function(e){var t=document.createElement("a"),a=document.createEvent("HTMLEvents");a.initEvent("click",!1,!1),t.href=e,t.dispatchEvent(a)}},t=function(e){var t=e.support.localStorage();return _localSetValue=function(e,t){localStorage.setItem(e,t)},_localGetValue=function(e){return localStorage.getItem(e)},_cookieSetValue=function(){},_cookieGetValue=function(){},{get:function(e){return t?_localGetValue(e):_cookieGetValue(e)},set:function(a,i){void 0!==a&&e.isString(a)&&(t?_localSetValue(a,i):_cookieSetValue(a,i))}}}(e),a=function(){var e=t.get("dirname");e?$.ajax({url:"/pendanter/getprojectopt",data:"dirname="+encodeURIComponent(e),type:"POST",dataType:"json",success:function(t){var a=t.opt;$("#optquality").html(a),$(".opt-options a[opt="+a+"]").addClass("active"),$("#sizelist .img,#sizelist .img-opt").each(function(){var t=$(this),i=t.attr("imgname"),n="";n=t.hasClass("img")?"uploads/"+e+"/original/"+i+".png":"uploads/"+e+"/"+a+"/"+i+".png",t.find("img").attr("src",n)}),o(e,a)}}):i()},i=function(){$("#sizelist .img,#sizelist .img-opt").each(function(){var e=$(this);filePath="img/holder.png",e.find("img").attr("src",filePath),$(".sizetag").hide()})},n={$dom:$(".loadingmask"),show:function(){this.$dom.removeClass("none")},hide:function(){this.$dom.addClass("none")}},o=function(e,t){var a={dirname:e,quality:t};$.ajax({url:"/pendanter/checkimgsize",data:a,type:"POST",dataType:"json",success:function(e){if(2==e.length){for(k in e[0]){var t=k.replace(".png",""),a=(e[0][k]/1024).toFixed(2)+"kb";$("#sizelist .img[imgname="+t+"] .sizetag").html(a)}for(k in e[1]){var t=k.replace(".png",""),a=(e[1][k]/1024).toFixed(2)+"kb";$("#sizelist .img-opt[imgname="+t+"] .sizetag").html(a)}$(".sizetag").fadeIn()}}})};~function(){var e=t.get("dirname"),n=t.get("pname"),o=t.get("hasimg"),s=t.get("haszip"),d=$(".step1"),r=$(".step2");e&&n?($(".scaler-wrap").removeClass("none"),$(".initaler").addClass("none"),$(".pname").html(n),$("#dropdirname").val(e),$(".table-list-wrap").css("height",$(window).height()-200+"px"),setTimeout(function(){new iScroll($(".table-list-wrap")[0],{vScroll:!0})},1e3)):($(".initaler").removeClass("none"),$(".scaler-wrap").addClass("none"),$(".projectlist").css("height",$(window).height()-170+"px"),setTimeout(function(){new iScroll($(".projectlist")[0],{vScroll:!0})},1e3)),"false"!=o?(a(),d.addClass("done")):(d.addClass("a-alert"),setTimeout(function(){d.removeClass("a-alert")},1e3),i()),"false"!=s?(r.addClass("done"),"false"!=o&&$(".package-download").removeClass("disabled")):(r.addClass("a-alert"),setTimeout(function(){r.removeClass("a-alert")},1e3))}(),$(window).on("resize",function(){$(".table-list-wrap").css("height",$(window).height()-200+"px")}),$(".add-project").on("click",function(){var e=$.trim($("#newproject_name").val());n.show(),$.ajax({url:"/pendanter/newproject",data:"pname="+encodeURIComponent(e),type:"POST",dataType:"json",success:function(e){n.hide(),e&&e.pname&&e.dirname?(t.set("pname",e.pname),t.set("dirname",e.dirname),t.set("hasimg",e.hasimg),t.set("haszip",e.haszip),location.reload()):alert("新建项目失败")}})}),$(".exit-tolist").on("click",function(){t.set("pname",""),t.set("dirname",""),location.reload()}),Dropzone.prototype.onStart=function(){n.show()},Dropzone.prototype.onComplete=function(e){if(n.hide(),200==e.xhr.status){if("zipdone"==e.xhr.response)t.set("haszip",!0);else if("pngdone"==e.xhr.response)t.set("hasimg",!0);else if("err_type"==e.xhr.response)return alert("文件格式有误，仅限png与zip文件"),void 0;location.reload()}else alert("上传失败，请重试")},$(".opt-options").delegate("a","click",function(){var e=$(this),a=e.attr("opt"),i=t.get("dirname");e.hasClass("active")||($(".opt-options a").removeClass("active"),e.addClass("active"),$.ajax({url:"/pendanter/changeopt",data:{opt:a,dirname:i},type:"POST",dataType:"html",success:function(e){"done"==e&&location.reload()}}))});var s=(new Dropzone("div#dropuploader",{url:"/files"}),-1),d=$(".original"),r=$(".img-targetsize"),l=$("#original_ourline"),c=$("#outline"),p=$("#add_width"),h=$("#add_height"),m=$("#add_x"),u=$("#add_y"),g=$("#add_name"),f=0;$(".add-section").on("click",function(){var e=d.width(),t=d.height(),a=d.attr("src");s=-1,r.attr("src",a).width(e),l.css({width:e+"px",height:t+"px"}),c.css({width:e+"px",height:t+"px"}),p.val(e),h.val(t)}).colorbox({inline:!0,width:"70%"}),p.on("keyup",function(){var e=$(this).val(),t=d.width(),a=d.height(),i=t/a,n=parseInt(e/i);isNaN(e)||(c.width(e).height(n),r.width(e),h.val(n),f=n)}),h.on("keyup",function(){var e=$(this).val();e!=f?c.addClass("changed").height(e):c.removeClass("changed").height(e)}),$(".sava-size").on("click",function(){var e={add_width:$("#add_width").val(),add_height:$("#add_height").val(),add_x:$("#add_x").val(),add_y:$("#add_y").val(),add_name:$("#add_name").val(),dirname:t.get("dirname")},a=0>s?"/pendanter/addnewsize":"/pendanter/sizemodify",i=!0;return e.sindex=s,$(".btn-edit").each(function(t){var a=$(this);(0>s&&a.attr("size-name")==e.add_name||s>=0&&t!=s&&a.attr("size-name")==e.add_name)&&(i=!1)}),/\.png/i.test(e.add_name)?(i?(n.show(),$.ajax({url:a,data:e,type:"POST",dataType:"html",success:function(){location.reload()}})):alert("存在同名文件，请更改文件名"),void 0):(alert("文件名必须以.png结尾"),void 0)}),$("#sizelist").delegate(".btn-edit","click",function(){var e=$(this),t=e.attr("sindex"),a={width:e.attr("size-width"),height:e.attr("size-height"),x:e.attr("size-x"),y:e.attr("size-y"),name:e.attr("size-name")};$.colorbox({href:"#addsection",inline:!0,width:"70%"}),s=t,p.val(a.width),h.val(a.height),m.val(a.x),u.val(a.y),g.val(a.name+".png")}),$("#sizelist").delegate(".btn-delete","click",function(){var e=$(this),a=e.attr("sindex");$.ajax({url:"/pendanter/sizedelete",data:{sindex:a,dirname:t.get("dirname")},type:"POST",dataType:"html",success:function(){location.reload()}})}),$(".package-download").on("click",function(){var a=!0,i=t.get("dirname"),o=t.get("pname");$(".step li").each(function(){var e=$(this);e.hasClass("done")||(a=!1,e.addClass("a-alert"),setTimeout(function(){e.removeClass("a-alert")},1e3))}),a&&i&&(n.show(),$.ajax({url:"/pendanter/getzip",data:{dirname:i},type:"POST",dataType:"html",success:function(){n.hide();var t=window.location.origin+"/uploads/"+i+"/"+o+".zip";e.downloadFile(t)}}))}),$(".projectlist").delegate(".btn-modify","click",function(){var e=$(this).attr("dirname");n.show(),$.ajax({url:"/pendanter/editproject",data:{dirname:e},type:"POST",dataType:"json",success:function(e){n.hide(),e&&e.pname&&e.dirname?(t.set("pname",e.pname),t.set("dirname",e.dirname),t.set("hasimg",e.hasimg),t.set("haszip",e.haszip),location.reload()):alert("打开失败")}})}),$(".projectlist").delegate(".btn-delete","click",function(){var e=$(this).attr("dirname");confirm("删除该挂件吗?")&&(n.show(),$.ajax({url:"/pendanter/deleteproject",data:{dirname:e},type:"POST",dataType:"html",success:function(){n.hide(),location.reload()}}))})});